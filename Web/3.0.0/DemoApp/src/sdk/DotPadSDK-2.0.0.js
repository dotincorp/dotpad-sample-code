const Command={requestDisplayLine:"0200",responseDisplayLine:"0201",notificateDisplayComplete:"0202",requestDisplayPartial:"0220",responseDisplayPartial:"0221",notificateDisplayPartial:"0222"},DataCodes=Object.freeze({Connected:"Connected",ConnectedFail:"ConnectedFail",Disconnected:"Disconnected",BoardInfo:"BoardInfo",BleMacAddress:"BleMacAddress",DeviceName:"DeviceName",DeviceFWVersion:"DeviceFWVersion",DeviceHWVersion:"DeviceHWVersion",ResponseDisplayLineAck:"ResponseDisplayLineAck",ResponseDisplayLineNonAck:"ResponseDisplayLineNonAck",ResponseDisplayLineComplete:"ResponseDisplayLineComplete",CommandError:"CommandError",CommandNone:"CommandNone"}),KeyCodes=Object.freeze({KeyFunction1:"KeyFunction1",KeyFunction2:"KeyFunction2",KeyFunction3:"KeyFunction3",KeyFunction4:"KeyFunction4",KeyFunction12:"KeyFunction12",KeyFunction13:"KeyFunction13",KeyFunction14:"KeyFunction14",KeyFunction23:"KeyFunction23",KeyFunction24:"KeyFunction24",KeyFunction34:"KeyFunction34",KeyElse:"KeyElse",PanningAll:"PanningAll",PanningLeft:"PanningLeft",PanningRight:"PanningRight",LPF1:"LPF1",RPF4:"RPF4"}),DeviceInfo=Object.freeze({DeviceName:"DeviceName",FirmwareVersion:"FirmwareVersion",HardwareVersion:"HardwareVersion"}),DisplayMode={GraphicMode:"GraphicMode",TextMode:"TextMode"},DeviceCellType=Object.freeze({D2:{name:"D2",models:["KM2-300A","KM2-20","DotPad320A","DPK12A","DotPad832A","DMI32A"]},D3:{name:"D3",models:["KM3-12A","KM3-08A","KM3-20A","KM3-40A","DPK12B","DotPad320C","DotPad320X","DotPad768A","DotPad300A"]},NONE:{name:"NONE",models:[]},fromDeviceName(e){return e=e??"",this.D2.models.some((t=>e.toLowerCase().includes(t.toLowerCase())))?this.D2:this.D3.models.some((t=>e.toLowerCase().includes(t.toLowerCase())))?this.D3:this.NONE}});class DotReceiver{#e=null;#t="";#s=null;#i=null;#n=null;#a=null;#r=null;#o=0;#h=!0;#c=0;#l=!0;#d=200;#u=null;#f=!1;#m=!0;constructor(e,t){this.#s=e,this.#i=t,this.#n={PERKINS_KEY:/aa55000900031200.*/,FUNCTION_KEY:/aa55000900033200.*/},this.#a={RSP_BOARD_INFO:/aa55001100011100.*/,RSP_FW_VER:/aa55000d00000100.*/,RSP_HW_VERSION:/aa55000600001100.*/,RSP_DEV_NAME:/aa55(....)00010100.*/},this.#r={ACK:{[Command.responseDisplayLine]:e=>this.#s(DataCodes.ResponseDisplayLineAck,e),[Command.responseDisplayPartial]:e=>this.#s(DataCodes.ResponseDisplayLineAck,e)},NOTI:{[Command.notificateDisplayComplete]:()=>this.#s(DataCodes.ResponseDisplayLineComplete,""),[Command.notificateDisplayPartial]:()=>this.#s(DataCodes.ResponseDisplayLineComplete,"")}}}async startUsbReadLoop(e){this.#e=e.readable.getReader();try{for(;;){const{value:e,done:t}=await this.#e.read();if(t)break;this.receiveHexPacket=Array.from(new Uint8Array(e.buffer)).map((e=>e.toString(16).padStart(2,"0"))).join(""),this.#D(this.receiveHexPacket)}}catch(e){console.error("read loop error",e)}finally{this.#e.releaseLock(),this.#e=null}}async stopReadLoop(){if(this.#e)try{await this.#e.cancel(),this.#e=null}catch(e){}}startBleNotification(e){this.receiveHexPacket=Array.from(new Uint8Array(e.target.value.buffer)).map((e=>e.toString(16).padStart(2,"0"))).join(""),this.#D(this.receiveHexPacket)}#D(e){this.#t.length>4&&!this.#t.startsWith("aa55")&&(this.#t=""),this.#t.length+e.length<18?(this.#t=`${this.#t}${e}`,e=""):(e=`${this.#t}${e}`,this.#t="");const t=this.#C(e);for(let e of t){this.#L(this.#n,e)?this.#p(this.#n,e):this.#L(this.#a,e)&&this.#y(this.#a,e);for(const[t,s]of Object.entries(this.#r.ACK)){const i=new RegExp(`aa550006(..)${t}(..)00.*`),n=e.match(i);if(n)return void s.call(this,n)}for(const[t,s]of Object.entries(this.#r.NOTI)){const i=new RegExp(`aa550006(..)${t}(..)00.*`);if(e.match(i))return void s.call(this)}}}#L(e,t){return Object.values(e).some((e=>t.match(e)))}#C(e){let t=[],s=0;for(;s<e.length;){if(e.length-s<18){this.#t=e.substring(s);break}const i=s+4,n=i+4,a=e.substring(i,n),r=parseInt(a,16);if(isNaN(r)){this.#t=e.substring(s);break}const o=s+8+2*r,h=e.substring(s,o);if(h.length!==2*r+8){this.#t=e.substring(s);break}t.push(h),s=o}return t}#y(e,t){const s=Object.keys(e).find((s=>t.match(e[s])));if(s){const e=16,i=t.substring(e,t.length-2),n=this.#g(i);switch(s){case"RSP_BOARD_INFO":this.#s(DataCodes.BoardInfo,i);break;case"RSP_FW_VER":this.#s(DataCodes.DeviceFWVersion,n);break;case"RSP_HW_VERSION":this.#s(DataCodes.DeviceHWVersion,i);break;case"RSP_DEV_NAME":this.#s(DataCodes.DeviceName,n)}}}#p(e,t){const s=Object.keys(e).find((s=>t.match(e[s])));if(s){if("PERKINS_KEY"===s){const e=parseInt(t.substr(19,1),16);this.#h=0===e,this.#o<e&&(this.#o=e)}else if("FUNCTION_KEY"===s){const e=parseInt(t.substr(16,1),16);this.#l=0===e,this.#c<e&&(this.#c=e)}this.#l&&this.#h&&(this.#m=!0),this.#m&&(this.#h&&this.#l?(null!==this.#u&&(clearTimeout(this.#u),this.#u=null),this.#f||this.#I(),this.#o=0,this.#c=0,this.#f=!1,this.#m=!0):null===this.#u&&(this.#f=!1,this.#u=setTimeout((()=>{this.#f||(this.#I(),this.#f=!0,this.#m=!1),this.#u=null}),this.#d)))}}#I(){let e=KeyCodes.KeyElse,t="";if(6===this.#o)0===this.#c&&(e=KeyCodes.PanningAll),t="AP + "+this.#c;else if(4===this.#o)8===this.#c?e=KeyCodes.LPF1:0===this.#c&&(e=KeyCodes.PanningLeft),t="LP + "+this.#c;else if(2===this.#o)1===this.#c?e=KeyCodes.RPF4:0===this.#c&&(e=KeyCodes.PanningRight),t="RP + "+this.#c;else if(0===this.#o){switch(this.#c){case 12:e=KeyCodes.KeyFunction12;break;case 10:e=KeyCodes.KeyFunction13;break;case 9:e=KeyCodes.KeyFunction14;break;case 8:e=KeyCodes.KeyFunction1;break;case 6:e=KeyCodes.KeyFunction23;break;case 5:e=KeyCodes.KeyFunction24;break;case 4:e=KeyCodes.KeyFunction2;break;case 3:e=KeyCodes.KeyFunction34;break;case 2:e=KeyCodes.KeyFunction3;break;case 1:e=KeyCodes.KeyFunction4}t=""+this.#c}this.#i(e,t)}#g(e){let t="";for(let s=0;s<e.length;s+=2){const i=e.substr(s,2),n=parseInt(i,16);t+=String.fromCharCode(n)}return t}}const SendMode={BASIC:"BASIC",REFRESH:"REFRESH"};class DotPadLine{#P=SendMode.BASIC;get sendMode(){return this.#P}constructor(e,t,s){this.lineId=e,this.startCellIndex=0,this.sendData="",this.seqNum="00",this.lineData="00".repeat(s),this.requestReady=!1,this.requestTime=t,this.receiveAck=!0,this.numberCellColumns=s,this.refreshLiveData="",this.refreshLiveStartCellIndex=0}getSendData(){return this.sendData}getLineId(){return this.lineId}getRequestReady(){return this.requestReady}getReceiveAck(){return this.receiveAck}setReceiveAck(e){this.receiveAck=e}setRequestReady(e){this.requestReady=e}getRequestTime(){return this.requestTime}getStartCellIndex(){return this.startCellIndex}getSeqNum(){return this.seqNum}refresh(e="ALL_DISPLAY"){this.requestReady||(this.requestReady=!0,this.receiveAck=!0,this.#P=SendMode.REFRESH,"LIVE_DISPLAY"==e?(this.sendData=this.refreshLiveData,this.startCellIndex=this.refreshLiveStartCellIndex):(this.sendData=this.lineData,this.startCellIndex=0))}initRefreshLiveData(e,t){this.refreshLiveData=t,this.refreshLiveStartCellIndex=e}setRefreshLiveData(e,t){const s=this.getMergeCellData(this.refreshLiveData,this.refreshLiveStartCellIndex,t,e);this.refreshLiveData=s.sendData,this.refreshLiveStartCellIndex=s.startCellIndex}setSendStatus(){this.requestReady=!1,this.receiveAck=!1}setCommand(e,t,s){if(this.#P=SendMode.BASIC,this.seqNum=e,!this.requestReady&&this.receiveAck)this.startCellIndex=t,this.sendData=s;else{const e=this.getMergeCellData(this.sendData,this.startCellIndex,s,t);this.sendData=e.sendData,this.startCellIndex=e.startCellIndex}this.requestReady=!0,this.receiveAck=!0,this.setLineData()}getMergeCellData(e,t,s,i){var n="",a=0;if(""==e)return{sendData:s,startCellIndex:i};if(t>=i){const r=t-i;if(2*r<s.length){const t="00".repeat(r)+e;n=s.length>=t.length?s:s+t.substring(s.length)}else{n=s+this.lineData.substring(2*i+s.length,2*t)+e}a=i}else{a=t;const r=i-t;if(2*r<e.length){const t=e.substring(0,2*r)+s;n=t.length>=e.length?t:t+e.substring(t.length)}else{n=this.lineData.substring(2*t,2*i)+s}}return{sendData:n,startCellIndex:a}}setLineData(){let e=this.lineData.substring(0,2*this.startCellIndex)+this.sendData;this.lineData=e+this.lineData.substring(e.length);const t=2*this.numberCellColumns-this.lineData.length;t>0&&(this.lineData+="00".repeat(t))}getLineData(){return this.lineData}}const BufferMode=Object.freeze({ALL_LINE:"ALL_LINE",SINGLE_LINE:"SINGLE_LINE",ALL_PARTIAL:"ALL_PARTIAL",SINGLE_PARTIAL:"SINGLE_PARTIAL",models:["DotPad320C","DotPad320X","DotPad300A"],fromDeviceName(e){const t=e.toLowerCase();return this.models.some((e=>t.includes(e.toLowerCase())))?this.ALL_PARTIAL:this.SINGLE_LINE}}),DotPadSendMakeModel={getSendData(e,t,s){var i="";switch(e){case BufferMode.ALL_LINE:i=this.makeTotalLineData(t);break;case BufferMode.SINGLE_LINE:i=this.makeSingleLineData(s);break;case BufferMode.ALL_PARTIAL:i=this.makeTotalPartialData(t);break;case BufferMode.SINGLE_PARTIAL:i=this.makeSinglePartialData(s)}return i},makeSingleLineData(e){let t=e.getSendData(),s=this.decimalToHex(e.getStartCellIndex())+t;return this.makePacket(s,e.getLineId(),e.getSeqNum(),Command.requestDisplayLine)},makeTotalLineData(e){var t="";for(let s=1;s<e.length;s++)t+=e[s].getLineData();let s=this.decimalToHex(0)+t;return this.makePacket(s,1,e[1].getSeqNum(),Command.requestDisplayLine)},makeSinglePartialData(e){let t=e.getSendData(),s=e.getStartCellIndex(),i=s+t.length/2,n=this.decimalToHex(s)+this.decimalToHex(i);return"80"==e.getSeqNum()?n+=this.brailleToGraphic(t):n+=t,this.makePacket(n,e.getLineId(),"00",Command.requestDisplayPartial)},makeTotalPartialData(e){let t=-1,s=-1,i=999,n=-1;for(let a=1;a<e.length;a++){const r=e[a];if(r.getRequestReady()){const e=r.getStartCellIndex(),o=e+r.getSendData().length/2;t<0&&(t=a),i>e&&(i=e),n<o&&(n=o),s=a}}let a="";if(t>-1){for(let r=t;r<=s;r++){a+=e[r].getLineData().slice(2*i,2*n)}let r=this.decimalToHex(i)+this.decimalToHex(n);return"80"==e[t].getSeqNum()?r+=this.brailleToGraphic(a):r+=a,this.makePacket(r,t,"00",Command.requestDisplayPartial)}return null},makePacket(e,t,s,i){const n=e.length/2;let a="AA55"+this.decimalToHex(5+n,4)+this.decimalToHex(t,2)+i+s+e;return a+=this.checksum(this.hexToBytes(a.substring(8))),this.hexStringToArrayBuffer(a)},hexStringToArrayBuffer(e){(e=e.replace(/^0x/,"")).length%2!=0&&console.warn("WARNING: expecting an even number of characters in the hexString");let t=e.match(/[G-Z\s]/i);t&&console.warn("WARNING: found non-hex characters",t);let s=e.match(/[\dA-F]{2}/gi);if(null!=s){let e=s.map((function(e){return parseInt(e,16)}));return new Uint8Array(e).buffer}return null},checksum(e){let t=165;for(let s=0;s<e.length;s++)t^=e[s];return("0"+(255&t).toString(16)).slice(-2)},decimalToHex:(e,t=2)=>Number(e).toString(16).padStart(t,"0"),hexToBytes(e){const t=[];for(let s=0;s<e.length;s+=2)t.push(parseInt(e.substr(s,2),16));return t},brailleToGraphic(e){const t=this.hexToBinary(e),s=[];for(let e=0;e<t.length;e+=8)s.push(t.substring(e,e+8));const i=s.map((e=>{const t=e.padEnd(8,"0"),s=t.substring(0,1),i=t.substring(1,2);return s+t.substring(2,5)+i+t.substring(5)}));return this.binaryToHex(i.join(""))},hexToBinary(e){let t="";for(let s=0;s<e.length;s++){t+=parseInt(e[s],16).toString(2).padStart(4,"0")}return t},binaryToHex(e){let t="";for(let s=0;s<e.length;s+=4){const i=e.substring(s,s+4);t+=parseInt(i,2).toString(16).toUpperCase()}return t}},RefreshType={TYPE_A:"TYPE_A",TYPE_B:"TYPE_B",TYPE_C:"TYPE_C"},RefreshMode={NONE:"NONE",ALL_DISPLAY:"ALL_DISPLAY",GRAPHIC_DISPLAY:"GRAPHIC_DISPLAY",TEXT_DISPLAY:"TEXT_DISPLAY",LIVE_DISPLAY:"LIVE_DISPLAY"};class DotPadSendModule{constructor(e){this.dotPadLineList=[],this.dotCommandSendReady=!0,this.sendTime=new Date,this.sendCnt=0,this.dotPadLine=null,this.restart=!1,this.currentIndex=0,this.isFunctionRunning=!1,this.dotPad=e,this.baseDisplayComplete=!0,this.refreshType=RefreshType.TYPE_C,this.refreshCount=0,this.refreshItem=null,this.refreshLine=[],this.refreshMode=RefreshMode.NONE,this.bufferMode=BufferMode.SINGLE_LINE,this.isAutoRefresh=!1}clearDotPadLine(){this.dotPadLineList=[]}addDotPadLine(e,t){const s=new DotPadLine(this.dotPadLineList.length,e,t);this.dotPad.cellType==DeviceCellType.D3&&s.setCommand("00",0,"00".repeat(t)),this.dotPadLineList.push(s)}#R(e,t,s,i,n=!0){n?(this.refreshCount=0,this.currentIndex=0):this.currentIndex=0,this.refreshMode!==RefreshMode.LIVE_DISPLAY||this.refreshLine.includes(e)?this.dotPadLineList[e].setRefreshLiveData(s,i):(this.refreshLine.push(e),this.dotPadLineList[e].initRefreshLiveData(s,i)),this.dotPadLineList[e].setCommand(t,s,i)}setDotPadLineCommand(e,t,s,i,n=!0){const a=this.dotPadLineList[e].getLineData(),r=a.substring(0,2*s)+i,o=this.compareString(r,a);if(null!==o){const[s,i]=o,a=r.slice(s,i+1);return this.#R(e,t,parseInt(s/2),a,n),!0}return!1}setDotCommandSendReady(e){this.dotCommandSendReady=e}async refresh(){for(let e=0;e<this.dotPadLineList.length;e++)this.dotPadLineList[e].refresh();await this.sendCommand()}checkBaseDisplay(){return this.isFunctionRunning&&this.currentIndex>=this.dotPadLineList.length-1||this.refreshCount>0||!this.isFunctionRunning}getIsFunctionRunning(){return this.isFunctionRunning}setDisplayComplete(){this.checkBaseDisplay()&&(this.baseDisplayComplete=!0)}getDisplayComplete(){return this.setDisplayComplete(),this.baseDisplayComplete}setBufferMode(e){this.bufferMode=e}getBufferMode(){return this.bufferMode}async sendCommand(e=!1){if(this.isFunctionRunning)this.restart=!0;else{this.isFunctionRunning=!0,this.currentIndex=0,e||(this.refreshCount=0);const t=this.dotPad.cellType,s=async()=>{if(this.currentIndex<this.dotPadLineList.length){if(this.restart){null!=this.refreshItem&&(clearTimeout(this.refreshItem),this.refreshItem=null);for(const e of this.dotPadLineList)e.sendMode==SendMode.REFRESH&&(e.setRequestReady(!1),e.setReceiveAck(!0));this.currentIndex=0,this.restart=!1,this.dotCommandSendReady=!0,this.refreshCount=0}else{if(this.currentIndex>0&&(this.bufferMode===BufferMode.ALL_LINE||this.bufferMode===BufferMode.ALL_PARTIAL)){let e=this.dotPadLineList.filter((e=>e.getRequestReady()));this.currentIndex=e.length>0?e[0].getLineId():this.currentIndex}if(this.dotPadLine=this.dotPadLineList[this.currentIndex],this.dotPadLine.getRequestReady()&&this.dotCommandSendReady){if(0===this.currentIndex||this.bufferMode===BufferMode.SINGLE_LINE||this.bufferMode===BufferMode.SINGLE_PARTIAL?this.dotPadLine.setSendStatus():this.dotPadLine.setReceiveAck(!1),this.currentIndex>=1&&0===this.refreshCount){let e=DotPadSendMakeModel.getSendData(this.bufferMode,this.dotPadLineList,this.dotPadLine);if(this.bufferMode===BufferMode.ALL_LINE||this.bufferMode===BufferMode.ALL_PARTIAL)for(let e=this.currentIndex;e<this.dotPadLineList.length;e++)this.dotPadLineList[e].setRequestReady(!1);await this.dotPad.sendCommand(e)}else{let e=DotPadSendMakeModel.makeSingleLineData(this.dotPadLine);await this.dotPad.sendCommand(e)}this.dotCommandSendReady=!1,0===this.refreshCount&&(this.baseDisplayComplete=!1),this.sendTime=new Date,this.sendCnt=0}else if(this.dotPadLine.getReceiveAck())this.dotCommandSendReady?this.currentIndex>=1&&0===this.refreshCount&&(this.bufferMode===BufferMode.ALL_LINE||this.bufferMode===BufferMode.ALL_PARTIAL)?(this.currentIndex=this.dotPadLineList.length,this.dotPadLine=null):this.currentIndex+=1:this.dotCommandSendReady=!0;else{if(new Date-this.sendTime>(()=>{const e=this.dotPadLine?.getRequestTime?.()??500;return this.currentIndex>=1&&0===this.refreshCount&&(this.bufferMode===BufferMode.ALL_LINE||this.bufferMode===BufferMode.ALL_PARTIAL)?"D3"===t?e*this.dotPadLineList.length:600:e})())if(this.sendCnt<3){if(this.currentIndex>=1&&0===this.refreshCount){if(this.bufferMode===BufferMode.ALL_LINE||this.bufferMode===BufferMode.ALL_PARTIAL)for(let e=this.currentIndex;e<this.dotPadLineList.length;e++)this.dotPadLineList[e].setRequestReady(!0);let e=DotPadSendMakeModel.getSendData(this.bufferMode,this.dotPadLineList,this.dotPadLine);if(await this.dotPad.sendCommand(e),this.bufferMode===BufferMode.ALL_LINE||this.bufferMode===BufferMode.ALL_PARTIAL)for(let e=this.currentIndex;e<this.dotPadLineList.length;e++)this.dotPadLineList[e].setRequestReady(!1)}else{let e=DotPadSendMakeModel.makeSingleLineData(this.dotPadLine);await this.dotPad.sendCommand(e)}this.sendTime=new Date,this.sendCnt+=1}else this.dotPadLine.setReceiveAck(!0),this.dotCommandSendReady=!0,this.baseDisplayComplete=!0}}"D2"===t&&this.refreshCommand(),setTimeout(s,1)}else this.isFunctionRunning=!1,this.baseDisplayComplete=!0};try{await s()}catch(e){console.log("sendCommand Error: ",e)}}}setDotPadLineReceiveAck(e,t){if(e>0&&(this.bufferMode===BufferMode.ALL_LINE||this.bufferMode===BufferMode.ALL_PARTIAL))for(let e=1;e<this.dotPadLineList.length;e++)this.dotPadLineList[e].setReceiveAck(t);else{const s=this.dotPadLineList[e];s&&s.setReceiveAck(t)}}setRefreshType(e){this.refreshType=e}refreshCommand(){if(this.dotPadLineList.length===this.currentIndex)switch(this.refreshType){case RefreshType.TYPE_A:this.refreshCommandFuncA();break;case RefreshType.TYPE_B:this.refreshCommandFuncB();break;case RefreshType.TYPE_C:this.refreshCommandFuncC()}}refreshCommandFuncA(){if(this.refreshCount<3){this.currentIndex=0;for(const e of this.dotPadLineList)e.refresh();this.refreshCount+=1}}refreshCommandFuncB(){if(this.refreshCount<3){this.currentIndex=0;for(let e=0;e<=3;e++)this.dotPadLineList[e].refresh()}else if(this.refreshCount<6){this.currentIndex=1;for(let e=4;e<=10;e++)this.dotPadLineList[e].refresh()}else this.refreshMode=RefreshMode.NONE;this.refreshCount+=1}refreshCommandFuncC(){if(null==this.refreshItem)switch(this.refreshMode){case RefreshMode.ALL_DISPLAY:this.refreshCommandFuncB();break;case RefreshMode.GRAPHIC_DISPLAY:this.graphicRefresh();break;case RefreshMode.TEXT_DISPLAY:this.textRefresh();break;case RefreshMode.LIVE_DISPLAY:this.liveRefresh()}}graphicRefresh(){this.refreshItem=()=>{if(this.refreshCount<3){this.currentIndex=1;for(let e=1;e<=3;e++)this.dotPadLineList[e].refresh()}else if(this.refreshCount<6){this.currentIndex=4;for(let e=4;e<this.dotPadLineList.length;e++)this.dotPadLineList[e].refresh()}else this.refreshMode=RefreshMode.NONE;this.refreshItem=null,this.refreshCount+=1,this.sendCommand(!0)},setTimeout(this.refreshItem,500)}textRefresh(){this.refreshCount<3?(this.refreshItem=()=>{this.currentIndex=0,this.dotPadLineList[0].refresh(),this.refreshItem=null,this.refreshCount+=1,this.sendCommand(!0)},setTimeout(this.refreshItem,1500)):this.refreshMode=RefreshMode.NONE}liveRefresh(){this.refreshCount<3?(this.refreshItem=()=>{this.currentIndex=0;for(const e of this.refreshLine)this.dotPadLineList[e].refresh(RefreshMode.LIVE_DISPLAY);this.refreshItem=null,this.refreshCount+=1,this.sendCommand(!0)},setTimeout(this.refreshItem,1500)):(this.refreshLine=[],this.refreshMode=RefreshMode.NONE)}setRefreshMode(e){clearTimeout(this.refreshItem),this.refreshItem=null,this.refreshMode!==RefreshMode.LIVE_DISPLAY&&e===RefreshMode.LIVE_DISPLAY&&(this.refreshLine=[]),this.refreshMode===RefreshMode.NONE?(this.refreshMode=e,this.refreshLine=[]):this.refreshMode!==RefreshMode.ALL_DISPLAY&&this.refreshMode!==e&&(this.refreshMode===RefreshMode.GRAPHIC_DISPLAY?e===RefreshMode.TEXT_DISPLAY&&(this.refreshMode=RefreshMode.ALL_DISPLAY):this.refreshMode===RefreshMode.TEXT_DISPLAY?e!==RefreshMode.TEXT_DISPLAY&&(this.refreshMode=RefreshMode.ALL_DISPLAY):this.refreshMode===RefreshMode.LIVE_DISPLAY&&(e===RefreshMode.TEXT_DISPLAY?this.refreshMode=RefreshMode.ALL_DISPLAY:e===RefreshMode.GRAPHIC_DISPLAY&&(this.refreshMode=RefreshMode.GRAPHIC_DISPLAY)))}compareString(e,t){let s=-1,i=-1,n=e.length;e.length>t.length&&(n=t.length);for(let a=0;a<n-1;a+=2){e.substring(a,a+2)!==t.substring(a,a+2)&&(-1===s&&(s=a),i=a+1)}return-1!==s?[s,i]:null}}const ConnectType={NONE:"",BLE:"BLE",USB:"USB"};class DotDevice{#s=null;#i=null;#M=null;#k=null;#v=ConnectType.NONE;#S=null;get connectDevice(){return this.#S}#b=null;#A=!1;get isConnect(){return this.#A}#T=20;#B="";#E="";get cellType(){return this.#E}#x=!1;#N=!1;#w=10;get numberCellRows(){return this.#w}#K=30;get numberCellColumns(){return this.#K}#_=1;#F=20;get numberBrailleCellColumns(){return this.#F}#H=600;#Y=600;#q=!1;#O=10;#G=3e3;constructor(e,t){this.#s=e,this.#i=t,this.DOTPAD_SERVICE="49535343-fe7d-4ae5-8fa9-9fafd205e455",this.DOTPAD_CHARACTERISTIC="49535343-1e4d-4bd9-ba61-23c647249616",this.#M=new DotReceiver(this.#V.bind(this),this.#U.bind(this)),this.#k=new DotPadSendModule(this)}async connectBleDevice(e){try{await e.gatt.connect();return this.#S=e,await this.#W(),this.#v=ConnectType.BLE,await this.#j(),await this.requestDeviceInfo(DeviceInfo.DeviceName),!0}catch(e){console.error(`BLE Device Connect failed: ${e.message}`)}return!1}async#W(){const e=await this.#S.gatt.getPrimaryService(this.DOTPAD_SERVICE),t=await e.getCharacteristic(this.DOTPAD_CHARACTERISTIC);t.startNotifications().then((()=>t.addEventListener("characteristicvaluechanged",(async e=>{this.#M.startBleNotification(e)})))),this.#S.addEventListener("gattserverdisconnected",(e=>{this.#V(DataCodes.Disconnected,"")}),{once:!0}),this.#b=t}async connectUsbDevice(e){try{return await e.open({baudRate:115200,dataBits:8}),this.#M.startUsbReadLoop(e),this.#S=e,this.#b=e.writable.getWriter(),this.#v=ConnectType.USB,await this.requestDeviceInfo(DeviceInfo.DeviceName),!0}catch(e){console.error(`USB Device Connect failed: ${e.message}`)}return!1}async disconnect(){if(!this.#A)return Promise.reject("Device is not connected.");this.#A=!1,this.#v===ConnectType.BLE?this.#S.gatt.disconnect():this.#v===ConnectType.USB&&(await this.#M.stopReadLoop(),await this.#b.close(),this.#S.close()),this.#S=null,this.#b=null,this.#s(this,DataCodes.Disconnected,"")}async sendCommand(e){if(this.#A)try{if(this.#v===ConnectType.BLE){let t=0;for(;t<e.byteLength;){let s=Math.min(this.#T,e.byteLength-t),i=e.slice(t,t+s);try{await this.#b.writeValue(i)}catch(e){return}t+=this.#T}return!0}if(this.#v===ConnectType.USB)return await this.#b.write(e),!0}catch(e){"NetworkError"===e.name&&19===e.code&&this.connected?(this.#A=!1,await this.disconnect()):this.#S?this.#v==ConnectType.BLE?await this.connectBleDevice(this.#S):this.#v==ConnectType.USB&&await this.connectUsbDevice(this.#S):(console.log(e.code,e.name,e.message),console.error(e))}}displayGraphicData(e,t=1,s=0,i=DisplayMode.GraphicMode){if(!this.#x)return;const n=i===DisplayMode.GraphicMode?"00":"80",a=this.#K,r=s,o=s+e.length/2;for(let i=t;i<=this.#w;i++){const h=i-1;if(h<0)continue;const c=h*a,l=c+a,d=Math.max(c,r),u=Math.min(l,o);if(d>=u||l<r)continue;const f=2*(d-r),m=2*(u-d),D=e.substring(f,f+m),C=t===i?s:0;this.#k.setDotPadLineCommand(i,n,C,D)}this.#k.setRefreshMode(RefreshMode.GRAPHIC_DISPLAY),this.#k.sendCommand(!0)}displayTextData(e,t=0,s=DisplayMode.TextMode){if(!this.#N)return;const i=s===DisplayMode.GraphicMode?"00":"80";this.#k.setDotPadLineCommand(0,i,t,e),this.#k.setRefreshMode(RefreshMode.TEXT_DISPLAY),this.#k.sendCommand(!0)}displayLineData(e,t=0,s,i){if(!this.#N&&0==e)return;if(!this.#x&&e>0)return;const n=i===DisplayMode.GraphicMode?"00":"80";this.#k.setDotPadLineCommand(e,n,t,s),this.#k.setRefreshMode(RefreshMode.LIVE_DISPLAY),this.#k.sendCommand(!0)}async#j(){let e=20,t=!0,s=10;for(;t;){let i=new Uint8Array(e).fill(171);try{await this.#b.writeValue(i),e+=s}catch(i){10==s?(e-=9,s=1):t=!1}}this.#T=e-1}async requestDeviceInfo(e){let t;switch(e){case DeviceInfo.DeviceName:t=DotPadSendMakeModel.makePacket("","00","00","0100");break;case DeviceInfo.FirmwareVersion:t=DotPadSendMakeModel.makePacket("","00","00","0000");break;case DeviceInfo.HardwareVersion:t=DotPadSendMakeModel.makePacket("","00","00","0010");break;default:return void console.warn("Unknown deviceInfo:",e)}this.#v===ConnectType.BLE?await this.#b.writeValue(t):this.#v===ConnectType.USB&&await this.#b.write(t)}async#X(){const e=DotPadSendMakeModel.makePacket("","00","00","0110");this.#v===ConnectType.BLE?await this.#b.writeValue(e):this.#v===ConnectType.USB&&await this.#b.write(e)}async#z(e){if(this.#B=e,this.#s(this,DataCodes.DeviceName,e),this.#B.includes("KM2-300A"))this.#$(0,0,20,15);else if(this.#B.includes("KM2-20"))this.#$(1,20,0,0);else{if(!this.#B.includes("KM3-20A"))return void await this.#X();this.#$(1,20,0,0)}this.#Z(),this.#$(),this.#V(DataCodes.Connected,"")}#J(e){const t=e.substring(0,2);let s=parseInt(t.substring(0,1),16);s>=8?(s-=8,this.#x=!0):this.#x=!1,s>=4?(s-=4,this.#N=!0):this.#N=!1,parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16),parseInt(e.substring(6,8),16);const i=parseInt(e.substring(8,10),16);this.#_=i;const n=parseInt(e.substring(10,12),16);this.#F=n,parseInt(e.substring(12,14),16);const a=parseInt(e.substring(14,16),16),r=parseInt(e.substring(16,18),16);this.#w=r;const o=parseInt(e.substring(18,20),16);this.#K=o,parseInt(e.substring(20,22),16);const h=parseInt(e.substring(22,24),16);if(0!==h&&0!==r){let e=3*Math.floor(100*h/r);e<300&&(e=300),this.#H=e}if(0!==a&&0!==i){let e=3*Math.floor(100*a/i);e<300&&(e=300),this.#Y=e}this.#Z(),this.#$(),this.#V(DataCodes.Connected,"")}#Z(){this.#E=DeviceCellType.fromDeviceName(this.#B).name,this.#k.setBufferMode(BufferMode.fromDeviceName(this.#B))}#$(e=this.#_,t=this.#F,s=this.#w,i=this.#K){if(this.#k.clearDotPadLine(),this.#N=e>0,this.#x=s>0,this.#N)for(let s=0;s<e;s++)this.#k.addDotPadLine(this.#Y,t);else this.#k.addDotPadLine(0,0);if(this.#x)for(let e=0;e<s;e++)this.#k.addDotPadLine(this.#H,i)}#V(e,t){switch(e){case DataCodes.Connected:this.#A=!0,this.#s(this,DataCodes.Connected,"");break;case DataCodes.Disconnected:this.#Q();break;case DataCodes.DeviceName:this.#z(t);break;case DataCodes.BoardInfo:this.#J(t);break;case DataCodes.ResponseDisplayLineAck:this.#k.setDotPadLineReceiveAck(parseInt(t[1],16),!0);break;case DataCodes.ResponseDisplayLineComplete:this.#k.setDotCommandSendReady(!0);break;default:this.#s(this,e,t)}}#U(e,t){this.#i(this,e,t)}async#Q(){if(this.#A&&this.#v===ConnectType.BLE)if(this.#S){if(!this.#q){this.#q=!0;try{for(let e=1;e<=this.#O;e++){console.log(`Reconnect try #${e}`);try{return await this.#ee(this.#G),await this.#W(),void console.log("Reconnect success")}catch(t){if(console.error("Reconnect failed:",t),e===this.#O)return console.log("Reconnect attempts exceeded. Force disconnect."),void this.disconnect()}}}finally{this.#q=!1}}}else this.disconnect()}async#ee(e){if(!this.#S)throw new Error("Device is null");const t=this.#S.gatt.connect();let s=null;try{const i=new Promise(((t,i)=>{s=setTimeout((()=>{i(new Error("BLE connect timeout"))}),e)}));return await Promise.race([t,i])}finally{null!==s&&clearTimeout(s)}}}class DotPadScanner{constructor(){this.DOTPAD_PREFIX="DotPad",this.DOTPAD_SERVICE="49535343-fe7d-4ae5-8fa9-9fafd205e455"}async startBleScan(){const e={filters:[{namePrefix:this.DOTPAD_PREFIX}],optionalServices:[this.DOTPAD_SERVICE]};try{return await navigator.bluetooth.requestDevice(e)}catch(e){if("NotFoundError"===e.name)return;console.error(e)}}async startUsbScan(){const e=[{usbVendorId:1027,usbProductId:24592},{usbVendorId:1027,usbProductId:24597}];try{return await navigator.serial.requestPort({filters:e})}catch(e){if("NotFoundError"===e.name)return;console.error(e)}}}class DotPadSDK{#te=[];messageCallBack=null;keyCallBack=null;getConnectedDevices(){return[...this.#te]}async connectBleDevice(e){for(const t of this.#te)if(t.connectDevice==e)return null;const t=new DotDevice(this.#se.bind(this),this.#U.bind(this));return await t.connectBleDevice(e)?(this.#te.push(t),t):null}async connectUsbDevice(e){for(const t of this.#te)if(t.connectDevice==e)return null;const t=new DotDevice(this.#se.bind(this),this.#U.bind(this));return await t.connectUsbDevice(e)?(this.#te.push(t),t):null}disconnect(e=null){if(null==e){for(const e of this.#te)e.disconnect();this.#te=[]}else e.disconnect(),this.#te=this.#te.filter((t=>t!==e))}requestDeviceInfo(e,t){e.requestDeviceInfo(t)}displayGraphicData(e,t=null,s=DisplayMode.GraphicMode){if(null==t)for(const t of this.#te)t.displayGraphicData(e,1,0,s);else t.displayGraphicData(e,1,0,s)}displayTextData(e,t=null,s=DisplayMode.TextMode){if(null==t)for(const t of this.#te)t.displayTextData(e,0,s);else t.displayTextData(e,0,s)}displayLineData(e,t,s,i,n=null){if(null==n)for(const n of this.#te)n.displayLineData(e,t,s,i);else n.displayLineData(e,t,s,i)}displayAllUp(e=null){if(null==e)for(const e of this.#te)e.displayTextData("FF".repeat(e.numberBrailleCellColumns)),e.displayGraphicData("FF".repeat(e.numberCellColumns*e.numberCellRows));else e.displayTextData("FF".repeat(e.numberBrailleCellColumns)),e.displayGraphicData("FF".repeat(e.numberCellColumns*e.numberCellRows))}displayAllDown(e=null){if(null==e)for(const e of this.#te)e.displayTextData("00".repeat(e.numberBrailleCellColumns)),e.displayGraphicData("00".repeat(e.numberCellColumns*e.numberCellRows));else e.displayTextData("00".repeat(e.numberBrailleCellColumns)),e.displayGraphicData("00".repeat(e.numberCellColumns*e.numberCellRows))}setCallBack(e,t){this.messageCallBack=e,this.keyCallBack=t}#se(e,t,s){t==DataCodes.Disconnected&&(this.#te=this.#te.filter((t=>t!==e))),this.messageCallBack&&this.messageCallBack(e,t,s)}#U(e,t,s){this.keyCallBack&&this.keyCallBack(e,t,s)}}export{DataCodes,DeviceInfo,DisplayMode,DotDevice,DotPadSDK,DotPadScanner,KeyCodes};